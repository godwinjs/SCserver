{"version":3,"file":"processMergedCells.js","names":["getCellStyleProperties","processMergedCells","data","schema","mergedCells","cloneData","slice","i","length","rowIndex","row","columnIndex","cell","span","rowSpan","processSpanningCells","push","cellStyleProperties","j","undefined","Error","JSON","stringify"],"sources":["../../source/write/processMergedCells.js"],"sourcesContent":["import getCellStyleProperties from './getCellStyleProperties.js'\r\n\r\n// Supports \"merging cells\" across columns and rows.\r\n// https://rdrr.io/cran/openxlsx/man/mergeCells.html\r\n//\r\n// Returned result example for merged cells range \"A2:C3\":\r\n// { mergedCells: [ [0, 1], [2, 2] ] }\r\n//\r\n// Data example:\r\n//\r\n// rows:\r\n// [\r\n//   [...],\r\n//   [\r\n//     { type: String, value: 'abc', span: 3, rowSpan: 2 },\r\n//     { ... },\r\n//     { ... }\r\n//   ],\r\n//   [...]\r\n// ]\r\n\r\nexport default function processMergedCells(data, { schema }) {\r\n\tconst mergedCells = []\r\n\r\n\tif (schema) {\r\n\t\treturn {\r\n\t\t\tdata,\r\n\t\t\tmergedCells\r\n\t\t}\r\n\t}\r\n\r\n\tlet cloneData = () => {\r\n\t\t// The code will apply the style from the originating \"merged\" cells\r\n\t\t// to their adjacent `null` cells, so clone `data` to prevent mutating it.\r\n\t\tdata = data.slice()\r\n\t\t// Also clone each row of `data`.\r\n\t\tlet i = 0\r\n\t\twhile (i < data.length) {\r\n\t\t\tdata[i] = data[i].slice()\r\n\t\t\ti++\r\n\t\t}\r\n\t\t// `data` has been cloned. No need to clone it again.\r\n\t\tcloneData = () => data\r\n\t\t// Return the cloned `data`.\r\n\t\treturn data\r\n\t}\r\n\r\n\tlet rowIndex = 0\r\n\twhile (rowIndex < data.length) {\r\n\t\tconst row = data[rowIndex]\r\n\t\tlet columnIndex = 0\r\n\t\twhile (columnIndex < row.length) {\r\n\t\t\tconst cell = row[columnIndex]\r\n\t\t\tif (cell) {\r\n\t\t\t\tconst { span = 1, rowSpan = 1 } = cell\r\n\r\n\t\t\t\tif (span > 1 || rowSpan > 1) {\r\n\t\t\t\t\t// Validate that `span`-ning or `rowSpan`-ning cells only overlap\r\n\t\t\t\t\t// `null` or `undefined` ones. Especially that `span`-ning or `rowSpan`-ning cells\r\n\t\t\t\t\t// don't overlap other `span`-ning or `rowSpan`-ning cells.\r\n\t\t\t\t\tprocessSpanningCells({ data, rowIndex, columnIndex, span, rowSpan, cloneData })\r\n\r\n\t\t\t\t\t// Add \"merged cells\" entry:\r\n\t\t\t\t\t// `[ [fromRowIndex, fromColumnIndex], [toRowIndex, toColumnIndex] ]`.\r\n\t\t\t\t\tmergedCells.push([\r\n\t\t\t\t\t\t[rowIndex, columnIndex],\r\n\t\t\t\t\t\t[\r\n\t\t\t\t\t\t\trowIndex + (rowSpan ? rowSpan - 1 : 0),\r\n\t\t\t\t\t\t\tcolumnIndex + (span ? span - 1 : 0)\r\n\t\t\t\t\t\t]\r\n\t\t\t\t\t])\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tcolumnIndex++\r\n\t\t}\r\n\t\trowIndex++\r\n\t}\r\n\r\n\treturn {\r\n\t\tdata,\r\n\t\tmergedCells\r\n\t}\r\n}\r\n\r\n// Validate that a `span`-ning / `rowSpan`-ning cell doesn't overlap\r\n// with other cells, especially `span`-ning / `rowSpan`-ning ones,\r\n// because those ones would make MS Office 2007 Excel say:\r\n// \"Excel found unreadable content in 'file.xlsx'.\r\n//  Do you want to recover the contents of this workbook?\r\n//  If you trust the source of this workbook, click Yes\".\r\nfunction processSpanningCells({ data, rowIndex, columnIndex, span, rowSpan, cloneData }) {\r\n\tconst cellStyleProperties = getCellStyleProperties(data[rowIndex][columnIndex])\r\n\r\n\tif (cellStyleProperties) {\r\n\t\tdata = cloneData()\r\n\t}\r\n\r\n\tlet i = rowIndex\r\n\twhile (i <= rowIndex + (rowSpan - 1)) {\r\n\t\tlet j = columnIndex\r\n\t\twhile (j <= columnIndex + (span - 1)) {\r\n\t\t\tconst cell = data[i][j]\r\n\t\t\tif (i > rowIndex || j > columnIndex) {\r\n\t\t\t\t// Validate that all hidden cells are `null` or `undefined`.\r\n\t\t\t\tif (cell !== null && cell !== undefined) {\r\n\t\t\t\t\tthrow new Error(`[write-excel-file] When using \\`span\\` or \\`rowSpan\\` parameters, all hidden overlapped cells should be represented by \\`null\\`s or \\`undefined\\`s. Cell at row ${rowIndex + 1} and column ${columnIndex + 1} is configured with \\`span\\` ${span} and \\`rowSpan\\` ${rowSpan}. Cell at row ${i + 1} and column ${j + 1} is neither \\`null\\` nor \\`undefined\\`: ${JSON.stringify(cell)}`)\r\n\t\t\t\t}\r\n\t\t\t\t// Apply the style from the original cell to this `null` cell.\r\n\t\t\t\t// https://gitlab.com/catamphetamine/write-excel-file/-/issues/43\r\n\t\t\t\tif (cellStyleProperties) {\r\n\t\t\t\t\tdata[i][j] = cellStyleProperties\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tj++\r\n\t\t}\r\n\t\ti++\r\n\t}\r\n}"],"mappings":"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"}