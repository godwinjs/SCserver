{"version":3,"file":"archive.js","names":["archiver","fs","Archive","outputPath","output","createWriteStream","archive","promise","Promise","resolve","reject","on","size","pointer","error","code","console","warn","pipe","filePath","internalPath","file","name","directoryPath","directory","content","append","finalize"],"sources":["../../source/write/archive.js"],"sourcesContent":["// Copy-pasted from:\r\n// https://github.com/catamphetamine/serverless-functions/blob/master/source/deploy/archive.js\r\n\r\n// Uses `archiver` library.\r\n// https://www.npmjs.com/package/archiver\r\n\r\nimport archiver from 'archiver'\r\n// import { WritableStream } from 'memory-streams'\r\nimport fs from 'fs'\r\n\r\n/**\r\n * A server-side *.zip archive creator.\r\n */\r\nexport default class Archive {\r\n  constructor(outputPath) {\r\n    let output\r\n    if (outputPath) {\r\n      output = fs.createWriteStream(outputPath)\r\n    } else {\r\n      // // Won't work for memory streams.\r\n      // // https://github.com/archiverjs/node-archiver/issues/336\r\n      // output = new WritableStream()\r\n    }\r\n\r\n    const archive = archiver('zip', {\r\n      // // Sets the compression level.\r\n      // zlib: { level: 9 }\r\n    })\r\n\r\n    this.archive = archive\r\n\r\n    if (output) {\r\n      this.promise = new Promise((resolve, reject) => {\r\n        // listen for all archive data to be written\r\n        // 'close' event is fired only when a file descriptor is involved\r\n        output.on('close', () => resolve({ size: archive.pointer() }))\r\n\r\n        // // This event is fired when the data source is drained no matter what was the data source.\r\n        // // It is not part of this library but rather from the NodeJS Stream API.\r\n        // // @see: https://nodejs.org/api/stream.html#stream_event_end\r\n        // archive.on('end', function() {\r\n        //   console.log('Data has been drained')\r\n        //   resolve({\r\n        //     // output: outputPath ? undefined : output.toBuffer(),\r\n        //     size: archive.pointer()\r\n        //   })\r\n        // })\r\n\r\n        // good practice to catch warnings (ie stat failures and other non-blocking errors)\r\n        archive.on('warning', function(error) {\r\n          if (error.code === 'ENOENT') {\r\n            // log warning\r\n            console.warn(error)\r\n          } else {\r\n            reject(error)\r\n          }\r\n        })\r\n\r\n        // good practice to catch this error explicitly\r\n        archive.on('error', reject)\r\n\r\n        // pipe archive data to the file\r\n        archive.pipe(output)\r\n      })\r\n    }\r\n  }\r\n\r\n  file(filePath, internalPath) {\r\n    this.archive.file(filePath, { name: internalPath })\r\n  }\r\n\r\n  directory(directoryPath, internalPath) {\r\n    this.archive.directory(directoryPath, internalPath);\r\n  }\r\n\r\n  append(content, internalPath) {\r\n    this.archive.append(content, { name: internalPath })\r\n  }\r\n\r\n  write() {\r\n    // Maybe `.finalize()` itself returns some `Promise`.\r\n    this.archive.finalize()\r\n    return this.promise || this.archive\r\n  }\r\n}\r\n"],"mappings":";;;;;;AAAA;AACA;AAEA;AACA;AAEA,OAAOA,QAAP,MAAqB,UAArB,C,CACA;;AACA,OAAOC,EAAP,MAAe,IAAf;AAEA;AACA;AACA;;IACqBC,O;EACnB,iBAAYC,UAAZ,EAAwB;IAAA;;IACtB,IAAIC,MAAJ;;IACA,IAAID,UAAJ,EAAgB;MACdC,MAAM,GAAGH,EAAE,CAACI,iBAAH,CAAqBF,UAArB,CAAT;IACD,CAFD,MAEO,CACL;MACA;MACA;IACD;;IAED,IAAMG,OAAO,GAAGN,QAAQ,CAAC,KAAD,EAAQ,CAC9B;MACA;IAF8B,CAAR,CAAxB;IAKA,KAAKM,OAAL,GAAeA,OAAf;;IAEA,IAAIF,MAAJ,EAAY;MACV,KAAKG,OAAL,GAAe,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;QAC9C;QACA;QACAN,MAAM,CAACO,EAAP,CAAU,OAAV,EAAmB;UAAA,OAAMF,OAAO,CAAC;YAAEG,IAAI,EAAEN,OAAO,CAACO,OAAR;UAAR,CAAD,CAAb;QAAA,CAAnB,EAH8C,CAK9C;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QAEA;;QACAP,OAAO,CAACK,EAAR,CAAW,SAAX,EAAsB,UAASG,KAAT,EAAgB;UACpC,IAAIA,KAAK,CAACC,IAAN,KAAe,QAAnB,EAA6B;YAC3B;YACAC,OAAO,CAACC,IAAR,CAAaH,KAAb;UACD,CAHD,MAGO;YACLJ,MAAM,CAACI,KAAD,CAAN;UACD;QACF,CAPD,EAjB8C,CA0B9C;;QACAR,OAAO,CAACK,EAAR,CAAW,OAAX,EAAoBD,MAApB,EA3B8C,CA6B9C;;QACAJ,OAAO,CAACY,IAAR,CAAad,MAAb;MACD,CA/Bc,CAAf;IAgCD;EACF;;;;WAED,cAAKe,QAAL,EAAeC,YAAf,EAA6B;MAC3B,KAAKd,OAAL,CAAae,IAAb,CAAkBF,QAAlB,EAA4B;QAAEG,IAAI,EAAEF;MAAR,CAA5B;IACD;;;WAED,mBAAUG,aAAV,EAAyBH,YAAzB,EAAuC;MACrC,KAAKd,OAAL,CAAakB,SAAb,CAAuBD,aAAvB,EAAsCH,YAAtC;IACD;;;WAED,gBAAOK,OAAP,EAAgBL,YAAhB,EAA8B;MAC5B,KAAKd,OAAL,CAAaoB,MAAb,CAAoBD,OAApB,EAA6B;QAAEH,IAAI,EAAEF;MAAR,CAA7B;IACD;;;WAED,iBAAQ;MACN;MACA,KAAKd,OAAL,CAAaqB,QAAb;MACA,OAAO,KAAKpB,OAAL,IAAgB,KAAKD,OAA5B;IACD;;;;;;SAtEkBJ,O"}